<html>
<head>
    <title>CusRep2</title>
    <script type="text/javascript">
	var GROUPIDCONSTANT = 4;
	var description="";
	 var GetsubCategoryFormDataResponse, GetsubCategoryGroupFormDataResponse, GetCustomReporsPopupDataResponse;
	 var i1=0,i2=0,i3=0,j1=1;
	 var tempReportName,anotherTempReportName;
	// var reportCatID, groupId,reportType,frequency
	 function getCustomReportsFormData() {
            var GetCustomGroupNameRequest = new XMLHttpRequest();
            GetCustomGroupNameRequest.open("GET", "CustomReportSettings.do?methodToCall=getCustomReportsFormData&req=%7B%7D", true);
            GetCustomGroupNameRequest.setRequestHeader("Content-Type", "application/json;charset=utf-8");
            GetCustomGroupNameRequest.send();
            GetCustomGroupNameRequest.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200) {
                    var responseFormData = JSON.parse(this.responseText);
					var categoryDataList = responseFormData.categoryData;
                  	var selectList = document.getElementById("repList");
					for(var i = 0; i < categoryDataList.length; i++) {
						var option = document.createElement('option');
						option.text = option.value = categoryDataList[i].value;
						option.id = categoryDataList[i].id;
						selectList.add(option, 0);
					}			
                }
            };
        }
		
	
		function getsubCategoryFormData() {
		var reportName;
		var selectRepCatname= document.getElementById("repList");
		reportName= selectRepCatname.options[selectRepCatname.selectedIndex].value;
		reportCatID = selectRepCatname.options[selectRepCatname.selectedIndex].id;
		reportName=reportName.split(" ").join("");
		reportName=reportName.substring(0,3);
			var GetsubCategoryFormDataRequest = new XMLHttpRequest();
			GetsubCategoryFormDataRequest.open("GET","CustomReportSettings.do?methodToCall=getsubCategoryFormData&req=%7B%22categoryId%22%3A%22"+reportCatID+"%22%7D", true);
	        GetsubCategoryFormDataRequest.setRequestHeader("Content-Type", "application/json;charset=utf-8");
            GetsubCategoryFormDataRequest.send();
  		    GetsubCategoryFormDataRequest.onreadystatechange = function () {
               if (this.readyState === 4 && this.status === 200) {
					GetsubCategoryFormDataResponse = JSON.parse(this.responseText);
					//for (var i = 0; i< GetsubCategoryFormDataResponse.length ; i++) {
					anotherTempReportName=reportName;
						anotherTempMethod(reportName,reportCatID); 
					
			   }
			}
         
		} 
		function anotherTempMethod(reportName,reportCatID)  {
						reportName=reportName+"_"+GetsubCategoryFormDataResponse[i1].value;
						reportName=reportName.split(" ").join("");
						reportName=reportName.substring(0,20);
						
						getSubCategoryGroupFormData(reportName,reportCatID,GetsubCategoryFormDataResponse[i1].id); 
						console.log("anotherTempMethod End3");
		}
		
		function getSubCategoryGroupFormData(reportName,reportCatID,groupId) {
		console.log("getSubCategoryGroupFormData start");
			GetsubCategoryGroupFormDataRequest = new XMLHttpRequest();
			GetsubCategoryGroupFormDataRequest.open("GET","CustomReportSettings.do?methodToCall=getsubCategoryGroupFormData&req=%7B%22groupId%22%3A%22"+groupId+"%22%7D", true);
			GetsubCategoryGroupFormDataRequest.setRequestHeader("Content-Type", "application/json;charset=utf-8");
			GetsubCategoryGroupFormDataRequest.send();
			GetsubCategoryGroupFormDataRequest.onreadystatechange = function () {
				if (this.readyState === 4 && this.status === 200) {
				GetsubCategoryGroupFormDataResponse = JSON.parse(this.responseText);
					//for (var i = 0; i< GetsubCategoryGroupFormDataResponse.length ; i++) {
					tempReportName=reportName;
					tempMethod(reportName,reportCatID,groupId);
					console.log("getSubCategoryGroupFormData End4");
					
					
			    }
			}
		}
		function tempMethod(reportName,reportCatID,groupId) {
			//if (i2< GetsubCategoryGroupFormDataResponse.length) {
						var temp=GetsubCategoryGroupFormDataResponse[i2].id;
					//	for ( var j=1 ; j <=4 ; j++) {
							
							//if ( j1<=4) {
							if(GetsubCategoryGroupFormDataResponse[i2].id-1 <= 2){
							var t=["t15min","t30min","t1hr","t2hr"];
							var c=["c1hr","c6hr","c12hr","c24hr"];
							if(temp==1) reportName=reportName+"_"+t[j1-1];
							else if(temp==2)  reportName=reportName+"_"+c[j1-1];
							getCustomReportsPopupData(reportName,reportCatID,groupId,GetsubCategoryGroupFormDataResponse[i2].id, j1);
							}
						//}
					//}
					console.log("tempMethod End");
		}
		
		function getCustomReportsPopupData(reportName,reportCatID, groupId ,  reportType, frequency) {
			console.log("getCustomReportsPopupData End");
			var GetCustomReporsPopupDataRequest = new XMLHttpRequest();
			GetCustomReporsPopupDataRequest.open("GET","CustomReportSettings.do?methodToCall=getCustomReportsPopupData&req=%7B%22subCategoryGroupId%22%3A%22"+groupId+"%22%7D");
			GetCustomReporsPopupDataRequest.setRequestHeader("Content-Type", "application/json;charset=utf-8");
			GetCustomReporsPopupDataRequest.send();
			GetCustomReporsPopupDataRequest.onreadystatechange = function () {
				if (this.readyState === 4 && this.status === 200) {
					GetCustomReporsPopupDataResponse = JSON.parse(this.responseText);
					
				}				
			}
		}
		
		function patMethod(patArray) {

            var viewArrays=[];
            var patArray = new XMLHttpRequest();
                            patArray.open("GET", "CustomReportSettings.do?methodToCall=getFilterData&req=%7B%22viewId%22%3A" + viewObject["viewId"] + "%7D");
                            patArray.setRequestHeader("Content-Type", "application/json;charset=utf-8");
                            patArray.send();
                            let newObject = [];
		patArray.onreadystatechange = function () {
                                if (this.readyState === 4 && this.status === 200) {
                                    let resp = JSON.parse(this.responseText);
                                    newObject["id"] = 1;
                                    newObject["columnList"] = resp.customReportConfigData.patternArray;
                                    newObject["columnListLength"] = 1;
                               }
                            }
            
					
					for ( var i=0; i< GetCustomReporsPopupDataResponse.viewArray.length ;i++) {
					// viewID, viewName, subCategoryList, isPatternType, columnList, filterList
						var viewObject = {};
						var subCategoryList=[];
						var columnList=[];
						viewObject["viewId"] = GetCustomReporsPopupDataResponse.viewArray[i].id;
						viewObject["viewName"] = GetCustomReporsPopupDataResponse.viewArray[i].value;
						for( var j=0; j< GetCustomReporsPopupDataResponse.viewArray[i].subCategoryArray.length ; j++) {
						subCategoryList.push(GetCustomReporsPopupDataResponse.viewArray[i].subCategoryArray[j].id);
						}
						viewObject["subCategoryList"] = subCategoryList;
						if(reportType==3) {
						frequency=0;
						viewObject["isPatternType"] = true;
                            
							viewObject["columnList"] = patMethod(patArray);
                            
						
						}
						else {viewObject["isPatternType"] = false;
						for( var j=0; j<GetCustomReporsPopupDataResponse.viewArray[i].columnTypeArray.length ; j++) {
						columnList.push(GetCustomReporsPopupDataResponse.viewArray[i].columnTypeArray[j].id);
						}
						viewObject["columnList"]=columnList;}
						var filterList=[];
						viewObject["filterList"] = filterList;
						viewArrays.push(viewObject);
					}
					
					saveCustomReport(reportName,description,reportCatID,groupId,frequency,reportType,viewArrays);
					//console.log("The End6");
					console.log("getCustomReportsPopupData End6");





                                    
		}
		
		function saveCustomReport(reportName,description,reportCatID,groupId,frequency,reportType,viewArray) {
            var SaveCustomReportRequest = new XMLHttpRequest();
            SaveCustomReportRequest.open("POST", "CustomReportSettings.do?methodToCall=saveCustomReport", true);
			SaveCustomReportRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			var params = '{"reportName":"'+ reportName +'","description":"'+ description +'","categoryId":"'+reportCatID+'","groupId":"'+groupId+'","frequency":"'+frequency+'","reportType":"'+ reportType +'","viewsData":'+JSON.stringify(viewArray)+'}';
			params = "req=" + params ;
			SaveCustomReportRequest.send(params);
			SaveCustomReportRequest.onreadystatechange = function () {
				if (this.readyState === 4 && this.status === 200) {
					  if(j1<4) {console.log("saveCustomReport j1"); j1++; tempMethod(tempReportName,reportCatID,groupId); }
					  else if(i2<(GetsubCategoryGroupFormDataResponse.length-1)) { console.log("saveCustomReport End-1"+j1+i2);j1=1;i2++; tempMethod(tempReportName,reportCatID,groupId); }
					  else if(i1<GetsubCategoryFormDataResponse.length) {console.log("saveCustomReport End10");i2=0;j1=1;i1++; anotherTempMethod(anotherTempReportName,reportCatID);
					  console.log("saveCustomReport End2"); }
					  else console.log("saveCustomReport End");
				      console.log("saveCustomReport End1")
				}
             };
		}
		
		getCustomReportsFormData();
	</script>
</head>
<body>
<label for="repList">Select Report Group</label>
<select id="repList">
   
</select>
<input type="button" value="Create" onclick="getsubCategoryFormData()"/>
<b><label id="result"></label></b>

</body>
</html>